import os
import feedparser
import google.generativeai as genai
from linebot import LineBotApi
from linebot.models import TextSendMessage
import yfinance as yf
import pandas as pd
import pandas_ta as ta
from datetime import datetime, timedelta
import pytz

# --- è¨­å®šç’°å¢ƒè®Šæ•¸ (å¾ GitHub Secrets è®€å–) ---
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
LINE_TOKEN = os.environ.get("LINE_TOKEN")
GROUP_ID = os.environ.get("GROUP_ID") # ä½ çš„ç¾¤çµ„ ID

# --- è‡ªè¨‚ç›£æ§æ¸…å–® ---
# ä½ å¯ä»¥åœ¨é€™è£¡å¢æ¸›ä½ æƒ³ç›£æ§çš„è‚¡ç¥¨ä»£è™Ÿ
WATCHLIST = ["NVDA", "TSLA", "AAPL", "AMD", "MSFT", "GOOG", "AMZN", "META", "TQQQ", "SOXL"]

# --- è‡ªè¨‚æ–°èä¾†æº (RSS) ---
RSS_URLS = [
    "https://www.cnbc.com/id/10000664/device/rss/rss.html", # CNBC Finance
    "https://feeds.content.dowjones.com/public/rss/mw_topstories" # MarketWatch
]

def get_technical_analysis():
    """åˆ†æç›£æ§æ¸…å–®ï¼ŒæŠ“å‡ºè²·è³£ç«­ç›¡èˆ‡å¤§å–®è¨Šè™Ÿ"""
    signals = []
    print("æ­£åœ¨åˆ†ææŠ€è¡“æŒ‡æ¨™...")
    
    for ticker in WATCHLIST:
        try:
            # æŠ“å–è³‡æ–™ (æ—¥ç·š)
            df = yf.download(ticker, period="2mo", interval="1d", progress=False)
            if len(df) < 14: continue 

            # è¨ˆç®—æŒ‡æ¨™
            # 1. RSI (ç›¸å°å¼·å¼±æŒ‡æ¨™)
            rsi = df.ta.rsi(length=14).iloc[-1]
            
            # 2. æˆäº¤é‡ç•°å‹•
            current_vol = df['Volume'].iloc[-1]
            avg_vol = df['Volume'].rolling(window=5).mean().iloc[-1]
            vol_ratio = float(current_vol) / float(avg_vol) if float(avg_vol) > 0 else 1.0

            # --- åˆ¤æ–·é‚è¼¯ ---
            ticker_signals = []
            
            # A. è²·ç›¤ç«­ç›¡ (RSI > 75)
            if rsi > 75:
                ticker_signals.append(f"âš ï¸ è²·ç›¤ç«­ç›¡ (RSI {rsi:.0f})")
            
            # B. è³£ç›¤ç«­ç›¡ (RSI < 25)
            elif rsi < 25:
                ticker_signals.append(f"ğŸ’ è³£ç›¤ç«­ç›¡ (RSI {rsi:.0f})")
                
            # C. å¤§å–®çŒå…¥ (æˆäº¤é‡ > 5æ—¥å‡é‡ 2å€)
            if vol_ratio > 2.0:
                ticker_signals.append(f"ğŸ”¥ å¤§å–®çŒå…¥ (é‡å¢ {vol_ratio:.1f}å€)")

            # å¦‚æœæœ‰ä»»ä½•è¨Šè™Ÿï¼Œå°±åŠ å…¥å ±å‘Š
            if ticker_signals:
                signals.append(f"ã€{ticker}ã€‘: {' '.join(ticker_signals)}")

        except Exception as e:
            print(f"åˆ†æ {ticker} å¤±æ•—: {e}")
            continue

    if not signals:
        return "ä»Šæ—¥ç›£æ§åå–®ç±Œç¢¼ç©©å®šï¼Œç„¡ç‰¹æ®Šç•°å¸¸è¨Šè™Ÿã€‚"
    return "\n".join(signals)

def get_news():
    """æŠ“å– RSS æ–°èæ‘˜è¦"""
    news_content = ""
    print("æ­£åœ¨æŠ“å–æ–°è...")
    try:
        for url in RSS_URLS:
            feed = feedparser.parse(url)
            for entry in feed.entries[:3]: # æ¯å€‹ä¾†æºå–å‰ 3 å‰‡
                news_content += f"- {entry.title}\n"
    except Exception as e:
        print(f"æŠ“æ–°èéŒ¯èª¤: {e}")
    return news_content

def generate_report():
    """æ•´åˆè³‡æ–™ä¸¦ç”¨ AI å¯«å ±å‘Š"""
    raw_news = get_news()
    tech_signals = get_technical_analysis()
    
    # å°ç£æ™‚é–“
    tw_time = datetime.now(pytz.timezone('Asia/Taipei')).strftime('%Y/%m/%d')

    print("å‘¼å« Gemini åˆ†æä¸­...")
    genai.configure(api_key=GEMINI_API_KEY)
    model = genai.GenerativeModel('gemini-pro')
    
    prompt = f"""
    ä½ æ˜¯è¯çˆ¾è¡—è³‡æ·±äº¤æ˜“å“¡ã€‚è«‹æ ¹æ“šä»¥ä¸‹è³‡æ–™ï¼Œç‚º LINE ç¾¤çµ„æ’°å¯«ä¸€ä»½ã€Œç¾è‚¡æ™¨é–“æˆ°å ±ã€ã€‚
    
    ã€è³‡æ–™ Aï¼šæ˜¨æ™šé‡é»æ–°èæ¨™é¡Œã€‘
    {raw_news}
    
    ã€è³‡æ–™ Bï¼šæŠ€è¡“é¢ç›£æ§è¨Šè™Ÿ (RSI/çˆ†é‡)ã€‘
    {tech_signals}
    
    ---
    è«‹ä»¥ã€Œç¹é«”ä¸­æ–‡ã€æ’°å¯«ï¼Œèªæ°£å°ˆæ¥­ã€ç°¡æ½”ï¼Œé©åˆæ‰‹æ©Ÿé–±è®€ã€‚
    æ ¼å¼å¦‚ä¸‹ï¼ˆè«‹åš´æ ¼éµå®ˆï¼‰ï¼š
    
    ğŸ“Š **ç¾è‚¡æ™¨é–“æˆ°å ±** ({tw_time})
    
    **1. å¸‚å ´é¢¨å‘**ï¼š(ç”¨ä¸€å¥è©±ç¸½çµæ˜¨æ—¥ç¾è‚¡æƒ…ç·’ï¼Œå¦‚ææ…Œã€è§€æœ›æˆ–è²ªå©ª)
    
    **2. ç„¦é»æ–°è**ï¼š
    (å¾è³‡æ–™ A æŒ‘é¸ 2 å‰‡æœ€é‡è¦çš„æ–°èï¼Œä¸¦ä¸€å¥è©±è§£é‡‹å°è‚¡å¸‚çš„å½±éŸ¿)
    
    **3. æŠ€è¡“é¢ç•°å¸¸ (é‡é»)**ï¼š
    (æ•´ç†è³‡æ–™ B çš„å…§å®¹ã€‚è‹¥æœ‰å‡ºç¾ã€Œè²·ç›¤ç«­ç›¡ã€æç¤ºé¢¨éšªï¼›è‹¥æœ‰ã€Œè³£ç›¤ç«­ç›¡ã€æç¤ºæ©Ÿæœƒï¼›è‹¥æœ‰ã€Œå¤§å–®ã€æç¤ºé—œæ³¨ã€‚è‹¥ç„¡è¨Šè™Ÿå‰‡å¯«ã€Œè§€å¯Ÿåå–®èµ°å‹¢å¹³ç©©ã€ã€‚)
    
    **4. æ“ä½œå»ºè­°**ï¼š(çµ¦æ•£æˆ¶çš„ä¸€å¥è©±å»ºè­°)
    """
    
    response = model.generate_content(prompt)
    return response.text

def send_line_push(content):
    """æ¨æ’­åˆ°ç¾¤çµ„"""
    print("æº–å‚™ç™¼é€ LINE...")
    line_bot_api = LineBotApi(LINE_TOKEN)
    line_bot_api.push_message(GROUP_ID, TextSendMessage(text=content))

if __name__ == "__main__":
    try:
        report = generate_report()
        send_line_push(report)
        print("ç™¼é€æˆåŠŸï¼")
    except Exception as e:
        print(f"åŸ·è¡Œå¤±æ•—: {e}")